<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv='X-UA-Compatible' content='IE=edge' />
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
    <title>Example-SMART-App</title>

    <link rel='stylesheet' type='text/css' href='./src/css/example-smart-app.css'>
    <link rel='stylesheet' type='text/css' href='./src/css/print.css'>
    <link rel='stylesheet' type='text/css' href='./src/css/screen.css'>
    <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet'/>
    <style>
      .conditionReaction {
        display: none;
      }
      .pending {
        color:  #3b584b;
      }
      .details .plan-raw {
        display: none;
      }

      #subjectinfo {
        display: block;
        width: 100%;
        opacity: 1;
      }

      #togglebox {
        display: none;
        text-align: center;
        margin: auto;
        width: 100%;
        background-color: rgba(248, 246, 244, 0.75);
        padding: 50px;
        position: fixed;
      }

     .submitconditionchange {
        display: none;
        text-align: center;
        margin: auto;
        width: 100%;
        background-color: rgba(248, 246, 244, 0.75);
        padding: 50px;
        position: fixed;
     }

      textarea {
        font-family: 'Roboto Slab', serif;
        line-height: 225%;
      }

      #closePad #anchor {
        position: fixed;
        background: #bb0707;
        padding: 4px 6px;
        color: white;
        right: 0;
        top: 20;
        z-index: 9001;
        width: 195px;
        height: 50px;
      }
      .checkmark__circle {
        stroke-dasharray: 166;
        stroke-dashoffset: 166;
        stroke-width: 2;
        stroke-miterlimit: 10;
        stroke: #bb0707;
        fill: none;
        animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
      }

      .checkmark {
          position: fixed;
                right: 0;
          top: 35;
          width: 56px;
          height: 56px;
          border-radius: 50%;
          display: block;
          stroke-width: 2;
          stroke: #fff;
          stroke-miterlimit: 10;
          margin: 10% auto;
          box-shadow: inset 0px 0px 0px #bb0707;
          animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
      }

     .checkmark__check {
        transform-origin: 50% 50%;
        stroke-dasharray: 29;
        stroke-dashoffset: 29;
        animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
      }

      @keyframes stroke {
        100% {
           stroke-dashoffset: 0;
        }
      }
      @keyframes scale {
        0%, 100% {
          transform: none;
        }

        50% {
          transform: scale3d(1.1, 1.1, 1);
        }
    }

    @keyframes fill {
       100% {
          box-shadow: inset 0px 0px 0px 30px #bb0707;
       }
    }

   .responseBox {
    }
    </style>
  </head>
  <body>
    <div class="conditionCodes">
    </div>
    <div class="conditionReaction"></div>
    <div id='subjectinfo'>
      <div id="togglebox">
        <div id="closePad">
         <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none" />
            <path class="checkmark__check" fill="none" d="M16 16 36 36 M36 16 16 36" />
         </svg>
         <a href="#" id="anchor">close</a>
        </div>
        <input type='submit' name='done' value='done?'/>
        <input type='submit' name='completed' value='completed?'/>
        <input type='submit' name='afas' value='callback?'/>
      </div>
    </div>
    <div class='submitconditionchange'>
      <b>*NOTICE*</b>
      <p>If you're changing the code of the condition,</p>
      <p>please follow the snowmed nomenclacture</p>
      <a href='https://www.hl7.org/fhir/valueset-condition-code.html'>https://www.hl7.org/fhir/valueset-condition-code.html</a>

      <form method="POST" action="./" name="COC">
        <label>ID_:</label>
        <input name="id" value="" disabled/>
        <label>Category:</label>
        
        <fieldset>
          <legend>http://argonaut.hl7.org</legend>
          <input name="category" type="radio" value="problem">Problem<br>
          <input name="category" type="radio" value="diagnosis">Diagnosis<br>
        </fieldset>

        <label>Code Type (Please Refer To Classification Above)</label>
        <input list="codes">
        <datalist id="codes">
        </datalist>
        <label>Custom Category Title</label>
        <input name="title" value="">
        <label>Description Of Condition</label>
        <textarea name="description" wrap=hard></textarea>
        <label>Clinical Status</label>
        <select name='clinicalstatus'>
        <!--active | recurrence | inactive | remission | resolved-->
        <option value="active" selected>active</option>
        <option value="recurrence">recurrence</option>
        <option value="inactive">inactive</option>
        <option value="resolved">resolved</option>
        <option value="remission">remission</option>
        </select>
        <input type="submit" value="Process"/>
      </form>
      
      <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
              <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none" />
        <path class="checkmark__check" fill="none" d="M16 16 36 36 M36 16 16 36" />
      </svg>
    </div>
    <div id='errors'>
    </div>
    <div id="loading" class="spinner">
      <div class="bounce1"></div>
      <div class="bounce2"></div>
      <div class="bounce3"></div>
    </div>
    <div id='holder' >
      <h2>Example-SMART-App</h2>

      <h2>Patient Resource</h2>
      <table class="patient">
        <tr>
          <th>First Name:</th>
          <td id='fname'></td>
        </tr>
        <tr>
          <th>Last Name:</th>
          <td id='lname'></td>
        </tr>
        <tr>
          <th>Gender:</th>
          <td id='gender'></td>
        </tr>
        <tr>
          <th>Date of Birth:</th>
          <td id='birthdate'></td>
        </tr>
        <tr>
          <th>Age:</th>
          <td id='age'></td>
        </tr>
      </table>
      <h2>Observation Resource</h2>
      <table>
        <tr>
          <th>Height:</th>
          <td id='height'></td>
        </tr>
        <tr>
          <th>Systolic Blood Pressure:</th>
          <td id='systolicbp'></td>

        </tr>
        <tr>
          <th>Diastolic Blood Pressure:</th>
          <td id='diastolicbp'></td>
        </tr>
        <tr>
          <th>LDL:</th>
          <td id='ldl'></td>
        </tr>
        <tr>
          <th>HDL:</th>
          <td id='hdl'></td>
        </tr>
      </table>
    <h2>Emergency Guardians/Contacts</h2>
    <table class="contacts">
      <thead>
        <tr>
          <th><em><u>Attributes</u></em</th>
          <th><em><u>Values</u></em></th>
      </thead>
      <tbody>
        <tr class='names'>
          <th>Name:</th>
        </tr>
        <tr class='cells'>
          <th>Cell Number:</th>
        </tr>
        <tr class='emails'>
          <th>Email:</th>
        </tr>
        <tr class='phones'>
          <th>Phone:</th>
        <tr class='addresses'>
          <th>Address</th>
        </tr>
        <tr class='relationships'>
          <th>Relationship</th>
        </tr>
      </tbody>
    </table>

    <h2>Care Plans</h2>
    <table class="care">
      <thead>
        <tr>
          <th>Plan Name</th>
          <th>Status</th>
          <th>Original PT</th>
          <th>Details</th>
          <th>Last Modified</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
   
    <h2>Conditions</h2> 
     <p>From the sandbox, the query is capped to 5 condition readings</p>
     <p>To change the conditions, select the condition id and change</p>
     <p>the field values to submit to AFAS</p>

    <table class="conditions">
      <thead>
        <tr>
          <th>Condition ID</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    
    <div class="responseBox">
      <button class="expand">+</button>
      <button class="minus">-</button>
      Messages
      <div class="audits"></div>
    </div>

    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js'></script>
    <script src='./src/js/setupplans.js'></script>
    <script src='./lib/es6-shim-0.35.1.min.js'></script>
    <script src='./src/js/example-smart-app.js'></script>
    <script src='./lib/fhir-client-v0.1.11.js'></script>
    
    <!-- Prevent session bleed caused by single threaded embedded browser and sessionStorage API -->
    <!-- https://github.com/cerner/fhir-client-cerner-additions -->
    <script src='./lib/fhir-client-cerner-additions-1.0.0.js'></script>
    <script src='./src/js/crypto-js.js'></script>
    <script src='./src/js/afasjax.js'></script>
    <script src='./src/js/sentinels.js'></script>
    <script src='./src/js/changeconditions.js'></script>
    <!--<script src='./lib/vendor/intl-phone/js/intlTelInput.min.js'>-->
    
    <script>
        var tableRows;
        var plansReady; //when plans are compiled, we can run the function;
        extractData().then(function(data, conditions){
            //Scrape snomed conditions from hl7
            $.get("https://www.hl7.org/fhir/valueset-condition-code.html")

             .then((results)=>{
                      tableRows= results.match(/<table class=\"codes\">(<tr>\S+<\/tr>){1}(.*)<\/table>/i)
                      var breakTableRows = tableRows[2].split("<tr>").slice(1,);
                      breakTableRows.forEach((e,i,a)=>{
                        var groups = e.match(/<td><a\s?name=\"http\-{3}snomed\.info\-sct\-(\d+)\">\s?<\/a><a\s?.*>.*<\/a><\/td><td>(.*)<\/td>/i);
                        $('form[name=COC] > #codes').append("<option value='"+groups[1]+"'>"+groups[2]+"</option>");
                      });
             })

             .catch((err)=>console.log("an error occured")); 

            conditions.forEach((element,index,array)=>{addCondition(element)});
            //Display Patient Demographics and Observations if extractData was success
            console.log(data);
            plans = drawVisualization(data); //after placing patient observations and demographics, add carePlans for patient
            plansReady = findCarePlans(plans); //add the patients plans to the table above
            //setInterval(refreshToken, 1000*60*9);
            plansReady.then((the_objects)=>
              checkUpdated_(the_objects)
            );
            
            function replaceplan(event){
              //change the input to a regular text node
              $element = $(this)
              $element.off('click');
              console.debug(event);
              var cell = $(event.target).parent();
              var id = $element.attr('id');
              var content = cell.children('input').val();
              cell.children('input').remove();
              cell.children('button').text('overwrite?');
              cell.prepend(content);
              cell.children('button').removeClass('finished');
              $('.pressed').prop('disabled', false);
              $element.addClass('pressed');
              $element.click(pressbind);
              $('pressed').on('click', pressbind);
              $('.subjectdetails').prop('disabled', false);
            };

            function addplan(){
              //for later in lifecycle 8.*.17
            }
            
            function noteParser(){
              //Parsing the plan-div
              $("<form action='./' method='POST' class='trigsub'><textarea name=pad wrap=hard></textarea></form>").insertBefore('#togglebox > .plan-raw > pre:first');

              var textwidth = window.innerWidth/1.25;
              var textheight = window.innerHeight/2;

              $('#togglebox > .plan-raw > pre').each(function(index, val){
                index == 0 ? $('textarea').append("Please write above dotted line (you can write-over this)\n----------\n"+$( this ).text()) :
                $('textarea').append("\n----------\n"+$( this ).text()).css({width: textwidth, height: textheight});
              });
              $('#togglebox > .plan-raw > pre').remove();
              $('#togglebox > .plan-raw > p > b').each(function(enumer, val){
                if (val.innerText.toLowerCase() == "effective date/time"){
                  val.remove();
                  $( this ).parent().remove();
                  $('#togglebox > .plan-raw > p:last').remove(); //remove datestamp;
                }
              });
            };
            
            function pressbind(event){
                $element = $(this);
                $element.off('click', '#'+this.id + '.'+this.className);
                var cell = $element.parent();
                var id = $element.attr('id');
                var re = /<button .*>overwrite\?<\/button>/i;
                var content = cell.html();
                var raw_text = content.slice(0, content.match(re).index);
                var button = content.slice(content.match(re).index,);
                console.log([event, raw_text, content]);
                var input = "<input type='text' value='"+raw_text+"'>";
                cell.text('');
                cell.prepend(input);
                cell.append(button);
                cell.children('button').addClass('finished');
                $(this).removeClass('pressed');
                cell.children('.finished').text('finished');
                $lastmodified = cell.parent().children('.modified');
                _date = new Date().toISOString();
                $lastmodified.html(_date);

                /* Disable the modification to care plan to finish one at a time */
                $('.pressed').not('.finished').prop('disabled', true);
                $('.subjectdetails').prop('disabled', true);
                $element.click(replaceplan);
                $('.finished').on('click', replaceplan);
            };


          $('.pressed').click(pressbind);


          $('.subjectdetails').click(function rationdetails(event){
            var id = $(this).attr('id');
            $status = $("select[name=stat"+id+"]");
            $status.children().filter(':selected').prop("selected", false);
            $status.children().filter(':last').prop("selected", true); //TURN THE STATUS TO DRAFT

            $details = $(this).parent();
            $toggleBox = $('#togglebox');
            $toggleBox.prepend($details.html());
            $('#togglebox .subjectdetails').hide();
            $('input[name=done]').attr('id', id);
            $('input[name=completed]').attr('id', id);
            $toggleBox.toggle();
            $('.subjectdetails').prop('disabled', true);


            /* Present the subject detail front and center */
            $('#subjectinfo').css('background-color', 'white');
            $('#subjectinfo').css('opacity', '1');
            $('#togglebox').css('background-color', '#f9ebdc')
            noteParser(); //configure the subject details box to fit in middle of screen
          });

          $('input[name=done]').click(function(event){
            event.preventDefault();
            var status_id = this.id;
            $('input[name=done]').attr('id', '');
            $('input[name=completed]').attr('id', '');
            $toggleBox = $('#togglebox');
            new_memo = $('textarea').val();
            var new_appendum = new_memo.split('----------')[0];

          if (!/Please write above dotted line .*/.test(new_appendum)){
	       
           var pres = $("<pre>"+new_appendum+"</pre>");
           pres.insertAfter('.row'+status_id+' > .details > .plan-raw > p:eq(2)');

          }
          $('#togglebox > .plan-raw').remove(); //erase everything from the patient activity details in pad
          $toggleBox.toggle();
            $status = $("select[name=stat"+status_id+"]");
            $status.children().filter(':selected').prop("selected", false);
            $status.children().filter(':first').prop("selected", true); //revert back to active


            $lastmodified = $('.modified #'+status_id);
            $('.subjectdetails').prop('disabled', false);
            _date = new Date().toISOString();
            $lastmodified.html(_date);
            $('#subjectinfo').css('background-color', '');
            $('#subjectinfo').css('opacity', '1');
            //$('.trigsub').trigger('submit');

          });

          $('input[name=completed]').click(function(event){
            event.preventDefault();
            console.log($('textarea').text());
            var status_class = ".row"+this.id;
            console.log(status_class);
            makesure = confirm("Are you sure this is completed? You cannot request provisions once completed");
            if (makesure) {
              $row = $("tbody > tr"+status_class);
              console.log($row);
              $row.remove(); //remove from the carePlan table;
              $('input[name=done]').attr('id', '');
              $('input[name=completed]').attr('id', '');
              $toggleBox = $('#togglebox');
              $('#togglebox > .plan-raw').remove(); //clear the toggle box
              $toggleBox.toggle();

              $('#subjectinfo').css('background-color', '');
              $('#subjectinfo').css('opacity', '1');
              $('.subjectdetails').prop('disabled', false);
             // $('.trigsub').trigger('submit');
             /*
               NEED THE DTSU2 SCOPES TO TRIGGER A WRITE TO THE EMR SYSTEM
             */
             } else {

               // No further action required
             }
          });
	  
      $("#closePad #anchor").click((e)=>{
              $toggleBox = $('#togglebox');
              var new_memo = $('textarea').val();
              var new_appendum = new_memo.split('----------')[0];
        var status_id = $('input[name=done]').attr('id');
              $lastmodified = $('.modified #'+status_id);
              $('.subjectdetails').prop('disabled', false);
        if (!/Please write above dotted line .*/.test(new_appendum)){
           confirmation = confirm("modify this care plan?");
           if (confirmation){
          $lastmodified = $('.modified #'+status_id);
          _date = new Date().toISOString();
          $lastmodified.html(_date);
                var pres = $("<pre>"+new_appendum+"</pre>");
                pres.insertAfter('.row'+status_id+' > .details > .plan-raw > p:eq(2)');
           }
        }
        
        $('#subjectinfo').css('background-color', '');
        $('.subjectdetails').prop('disabled', false);
        $('#subjectinfo').css('opacity', '1');
              $status = $("select[name=stat"+status_id+"]");
              $status.children().filter(':selected').prop("selected", false);
              $status.children().filter(':first').prop("selected", true); //revert back to active
        $('#togglebox > .plan-raw').remove(); //erase everything from the patient activity details in pad
              $('input[name=done]').attr('id', '');
              $('input[name=completed]').attr('id', '');
        $toggleBox.toggle();
      });

       $("svg").click((e)=> $("#closePad #anchor").trigger("click"));
	     
         $('.status > select').on('focus', function(){
            previous = this.value;
            }).change(function(){
              $select = $(this);
              $option = $select.children('option:selected');
              if ($option.html() == 'cancelled'){
                //perform authorization check to ensure provider/patient has delete access
                } else if ($option.html() == 'completed'){
                confirmation = confirm("Are you sure this is completed? You cannot request provisions once completed");
                if (confirmation) { //TODO: need provider authorization;
                  $select.parent().parent().remove(); //remove the row;
                  } else {
                    this.value = previous;
                    $select.children('option:first').prop('selected', true); //revert back to active
                    previous = this.value;
                  };
                };
          });

       $('.responseBox').css({'right': '12px', 'background-color': 'rgb(240, 240, 240)', 
			      'text-align': 'end', 'padding-top': '5px', position: 'absolute',
			      'width': '175px', height: '30px', 'padding-left': '5px',
			      'top': window.screen.availHeight-44
			     });
       $('svg').css({top: 0});
      },
        //Display 'Failed to call FHIR Service' if extractData failed
        function(){
              $('#loading').hide();
              $('#errors').html('<p> Failed to call FHIR Service </p>');
        },
        function(){
          $('#loading').prepend("<span id=\'pending\'><b>information collected; this could take some time</b></span>");
        }
       );
       

    </script>
  </body>
</html>
