<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv='X-UA-Compatible' content='IE=edge' />
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
    <title>Example-SMART-App</title>

    <link rel='stylesheet' type='text/css' href='./src/css/example-smart-app.css'>
    <link rel='stylesheet' type='text/css' href='./src/css/print.css'>
    <link rel='stylesheet' type='text/css' href='./src/css/screen.css'>
    <link href='https://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet'/>
    <style>
      .pending {
        color:  #3b584b;
       }
      .details .plan-raw {
        display: none;
      }

      #subjectinfo{
        display: block;
        width: 100%;
        opacity: 1;
      }

      #togglebox {
        display: none;
        text-align: center;
        margin: auto;
        width: 100%;
        background-color: rgba(248, 246, 244, 1);
        padding: 50px;
        position: fixed;
      }

      textarea{
        font-family: 'Roboto Slab', serif;
        line-height: 225%;
      }
    </style>
  </head>
  <body>
    <div id='subjectinfo'>
      <div id="togglebox">
        <input type='submit' name='done' value='done?'/>
        <input type='submit' name='completed' value='completed?'/>
      </div>
    </div>
    <div id='errors'>
    </div>
    <div id="loading" class="spinner">
      <div class="bounce1"></div>
      <div class="bounce2"></div>
      <div class="bounce3"></div>
    </div>
    <div id='holder' >
      <h2>Example-SMART-App</h2>

      <h2>Patient Resource</h2>
      <table class="patient">
        <tr>
          <th>First Name:</th>
          <td id='fname'></td>
        </tr>
        <tr>
          <th>Last Name:</th>
          <td id='lname'></td>
        </tr>
        <tr>
          <th>Gender:</th>
          <td id='gender'></td>
        </tr>
        <tr>
          <th>Date of Birth:</th>
          <td id='birthdate'></td>
        </tr>
        <tr>
          <th>Age:</th>
          <td id='age'></td>
        </tr>
      </table>
      <h2>Observation Resource</h2>
      <table>
        <tr>
          <th>Height:</th>
          <td id='height'></td>
        </tr>
        <tr>
          <th>Systolic Blood Pressure:</th>
          <td id='systolicbp'></td>

        </tr>
        <tr>
          <th>Diastolic Blood Pressure:</th>
          <td id='diastolicbp'></td>
        </tr>
        <tr>
          <th>LDL:</th>
          <td id='ldl'></td>
        </tr>
        <tr>
          <th>HDL:</th>
          <td id='hdl'></td>
        </tr>
      </table>
    <h2>Emergency Guardians/Contacts</h2>
    <table class="contacts">
      <thead>
        <tr>
          <th><em><u>Attributes</u></em</th>
          <th><em><u>Values</u></em></th>
      </thead>
      <tbody>
        <tr id='names'>
          <th>Name:</th>
          <td id='kin_name'></td>
        </tr>
        <tr id='cells'>
          <th>Cell Number:</th>
          <td id='cell'></td>
        </tr>
        <tr id='emails'>
          <th>Email:</th>
          <td id='email'></td>
        </tr>
        <tr id='phones'>
          <th>Phone:</th>
          <td id='phone'></td>
        <tr id='addresses'>
          <th>Address</th>
          <td id='address'></td>
        </tr>
        <tr id='relationships'>
          <th>Relationship</th>
          <td id='relationship'></td>
        </tr>
      </tbody>
    </table>

    <h2>Care Plans</h2>
    <table class="care">
      <thead>
        <tr>
          <th>Plan Name</th>
          <th>Status</th>
          <th>Original PT</th>
          <th>Details</th>
          <th>Last Modified</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>

    </div>

    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js'></script>
    <script src='./src/js/setupplans.js'></script>
    <script src='./lib/es6-shim-0.35.1.min.js'></script>
    <script src='./src/js/example-smart-app.js'></script>
    <script src='./lib/fhir-client-v0.1.11.js'></script>
    
    <!-- Prevent session bleed caused by single threaded embedded browser and sessionStorage API -->
    <!-- https://github.com/cerner/fhir-client-cerner-additions -->
    <script src='./lib/fhir-client-cerner-additions-1.0.0.js'></script>
    <script>

        extractData().then(function(data){
        //Display Patient Demographics and Observations if extractData was success
            plans = drawVisualization(data);
            findCarePlans(plans); //add the patients plans to the table above

            function replaceplan(event){
              //change the input to a regular text node
              $element = $(this)
              $element.off('click');
              console.log(event);
              var cell = $(event.target).parent();
              var id = $element.attr('id');
              var content = cell.children('input').val();
              cell.children('input').remove();
              cell.children('button').text('overwrite?');
              cell.prepend(content);
              cell.children('button').removeClass('finished');
              $('.pressed').prop('disabled', false);
              $element.addClass('pressed');
              $element.click(pressbind);
              $('pressed').on('click', pressbind);
              $('.subjectdetails').prop('disabled', false);
            };

            function addplan(){
              //for today 8.3.17
            }
            
            function noteParser(){
              //Parsing the plan-div
              $("<form action='./' method='POST' class='trigsub'><textarea name=pad wrap=hard></textarea></form>").insertBefore('#togglebox > .plan-raw > pre:first');
              $('#togglebox > .plan-raw > pre').each(function(index, val){
                index == 0 ? $('textarea').append("Please write above dotted line (you can write-over this)\n----------\n"+$( this ).text()) :
                $('textarea').append("\n----------\n"+$( this ).text());
              });
              $('#togglebox > .plan-raw > pre').remove();
              $('#togglebox > .plan-raw > p > b').each(function(enumer, val){
                if (val.innerText.toLowerCase() == "effective date/time"){
                  val.remove();
                  $( this ).parent().remove();
                  $('#togglebox > .plan-raw > p:last').remove(); //remove datestamp;
                }
              });
            };
            
            function pressbind(event){
                $element = $(this);
                $element.off('click', '#'+this.id + '.'+this.className);
                var cell = $element.parent();
                var id = $element.attr('id');
                var re = /<button .*>overwrite\?<\/button>/i;
                var content = cell.html();
                var raw_text = content.slice(0, content.match(re).index);
                var button = content.slice(content.match(re).index,);
                console.log([event, raw_text, content]);
                var input = "<input type='text' value='"+raw_text+"'>";
                cell.text('');
                cell.prepend(input);
                cell.append(button);
                cell.children('button').addClass('finished');
                $(this).removeClass('pressed');
                cell.children('.finished').text('finished');
                $lastmodified = cell.parent().children('.modified');
                _date = new Date().toISOString();
                $lastmodified.html(_date);

                /* Disable the modification to care plan to finish one at a time */
                $('.pressed').not('.finished').prop('disabled', true);
                $('.subjectdetails').prop('disabled', true);
                $element.click(replaceplan);
                $('.finished').on('click', replaceplan);
            };


          $('.pressed').click(pressbind);

          $('.subjectdetails').click(function rationdetails(event){
            var id = $(this).attr('id');
            $status = $("select[name=stat"+id+"]");
            $status.children().filter(':selected').prop("selected", false);
            $status.children().filter(':last').prop("selected", true); //TURN THE STATUS TO DRAFT

            $details = $(this).parent();
            $toggleBox = $('#togglebox');
            $toggleBox.prepend($details.html());
            $('#togglebox .subjectdetails').hide();
            $('input[name=done]').attr('id', id);
            $('input[name=completed]').attr('id', id);
            $toggleBox.toggle();
            $('.subjectdetails').prop('disabled', true);


            /* Present the subject detail front and center */
            $('#subjectinfo').css('background-color', 'white');
            $('#subjectinfo').css('opacity', '1');
            $('#togglebox').css('background-color', '#f9ebdc')
            noteParser(); //configure the subject details box to fit in middle of screen
          });

          $('input[name=done]').click(function(event){
            event.preventDefault();
            var status_id = this.id;
            $('input[name=done]').attr('id', '');
            $('input[name=completed]').attr('id', '');
            $toggleBox = $('#togglebox');
            $('#togglebox > .plan-raw').remove(); //erase everything from the patient activity details

            $toggleBox.toggle();

            $status = $("select[name=stat"+status_id+"]");
            $status.children().filter(':selected').prop("selected", false);
            $status.children().filter(':first').prop("selected", true); //revert back to active


            $lastmodified = $('.modified #'+status_id);
            $('.subjectdetails').prop('disabled', false);
            console.log("subject details are no longer disabled");
            _date = new Date().toISOString();
            $lastmodified.html(_date);
            $('#subjectinfo').css('background-color', '');
            $('#subjectinfo').css('opacity', '1');
            console.log($('textarea').text());
            $('.trigsub').trigger('submit');
          });

          $('input[name=completed]').click(function(event){
            event.preventDefault();
            console.log($('textarea').text());
            var status_class = ".row"+this.id;
            console.log(status_class);
            makesure = confirm("Are you sure you would like to complete this, you cannot request provisions once completed");
            if (makesure) {
              $row = $("tbody > tr"+status_class);
              console.log($row);
              $row.remove(); //remove from the carePlan table;
              $('input[name=done]').attr('id', '');
              $('input[name=completed]').attr('id', '');
              $toggleBox = $('#togglebox');
              $('#togglebox > .plan-raw').remove(); //clear the toggle box
              $toggleBox.toggle();

              $('#subjectinfo').css('background-color', '');
              $('#subjectinfo').css('opacity', '1');
              $('.subjectdetails').prop('disabled', false);
              $('.trigsub').trigger('submit');
              console.log($('textarea').text());
             } else {

               // No further action required
             }
          });
        
          $('.trigsub').submit(function(event){
            event.preventDefault();
            console.log($('textarea').text());
          });
      },
        //Display 'Failed to call FHIR Service' if extractData failed
        function(){
              $('#loading').hide();
              $('#errors').html('<p> Failed to call FHIR Service </p>');
        },
        function(){
          $('#loading').prepend("<span id=\'pending\'><b>information collected; this could take some time</b></span>");
        }
       );

    </script>
  </body>
</html>
